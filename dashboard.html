<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dashboard - Gestor Avançado de Conversas</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
  />
  <style>
    /* Calendário simples */
    .calendar {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }
    .calendar-day {
      background: #e0f2fe;
      padding: 8px;
      border-radius: 4px;
      text-align: center;
      font-weight: bold;
      cursor: default;
    }
    .calendar-day[data-msgs="0"] {
      background: #f0f0f0;
      color: #aaa;
    }
  </style>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex justify-between items-center bg-[#09679c] text-white p-4 shadow-md">
    <div class="flex items-center gap-3">
      <img src="img/logo.png" alt="Logo Gringo" class="h-10 w-auto" />
      <h1 class="text-xl font-bold">Dashboard - Gestor Avançado de Conversas</h1>
    </div>
    <div class="flex items-center gap-3">
      <a href="painel.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition" title="Início">
        <i class="fas fa-home"></i> Início
      </a>
      <a href="whatsapp.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition" title="Retorno">
        <i class="fab fa-whatsapp"></i> Retorno
      </a>
      <a href="cadastro.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition" title="Cadastro">
        <i class="fas fa-user-plus"></i> Cadastro
      </a>
      <a href="contatos.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition" title="Contatos">
        <i class="fas fa-address-book"></i> Contatos
      </a>
      <button
        onclick="logout()"
        class="bg-[#053646] px-3 py-2 rounded hover:bg-[#032d39] transition"
        title="Sair"
      >
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </div>
  </header>

  <main class="flex-grow p-6 max-w-7xl mx-auto space-y-8">

    <h2 class="text-3xl font-bold mb-6 text-[#005075]">Gestor Avançado de Conversas WhatsApp</h2>

    <div id="msgStatus" class="mb-4 text-center text-green-600 font-semibold"></div>

    <section class="bg-white shadow rounded p-6">
      <h3 class="text-2xl font-semibold mb-4 text-[#09679c]">Resumo Geral</h3>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-6 text-center">
        <div class="bg-[#e0f2fe] rounded p-4">
          <p class="text-xl font-bold" id="totalConversas">0</p>
          <p class="text-gray-700">Conversas válidas (≥ 3 msgs e ≥ 10s)</p>
        </div>
        <div class="bg-[#ffe4e6] rounded p-4">
          <p class="text-xl font-bold" id="totalChamadas">0</p>
          <p class="text-gray-700">Chamadas (1 msg, ignorando disparos)</p>
        </div>
        <div class="bg-[#fff7e6] rounded p-4">
          <p class="text-xl font-bold" id="contatosSemConversa">0</p>
          <p class="text-gray-700">Sem mensagens</p>
        </div>
        <div class="bg-[#d1fae5] rounded p-4">
          <p class="text-xl font-bold" id="mediaSemanal">0</p>
          <p class="text-gray-700">Média semanal de mensagens</p>
        </div>
        <div class="bg-[#fef3c7] rounded p-4">
          <p class="text-xl font-bold" id="tempoTotalConversas">0s</p>
          <p class="text-gray-700">Tempo total de conversas</p>
        </div>
      </div>
    </section>

    <section class="bg-white shadow rounded p-6">
      <h3 class="text-2xl font-semibold mb-4 text-[#09679c]">Calendário Mensal de Mensagens (Mês Atual)</h3>
      <div class="calendar" id="calendario"></div>
    </section>

    <section class="bg-white shadow rounded p-6 overflow-auto max-h-[480px]">
      <h3 class="text-2xl font-semibold mb-4 text-[#09679c]">Detalhes por Contato</h3>
      <table class="w-full text-left border-collapse table-auto min-w-max">
        <thead>
          <tr class="bg-[#09679c] text-white">
            <th class="p-3 border border-white">Nome</th>
            <th class="p-3 border border-white">Telefone</th>
            <th class="p-3 border border-white">Origem</th>
            <th class="p-3 border border-white text-center">Mensagens válidas</th>
            <th class="p-3 border border-white text-center">Última Mensagem</th>
            <th class="p-3 border border-white text-center">Tempo total de conversa</th>
            <th class="p-3 border border-white text-center">Ações</th>
          </tr>
        </thead>
        <tbody id="listaGestor">
          <!-- linhas vão aqui -->
        </tbody>
      </table>
    </section>

  </main>

  <script>
    // Logout
    function logout() {
      localStorage.removeItem("usuarioLogado");
      window.location.href = "intranet.html";
    }

    // Mensagens consideradas como disparo único (não contam como conversa)
    const disparos = [
      "oi",
      "bom dia",
      "boa tarde",
      "boa noite",
      "olá",
      "ola"
    ];

    // Função que verifica se mensagem é disparo
    function isDisparo(texto) {
      if (!texto) return false;
      const txt = texto.toLowerCase().trim();
      return disparos.includes(txt);
    }

    // Pega contatos e mensagens (armazenados em localStorage)
    function pegarDados() {
      const contatos = JSON.parse(localStorage.getItem("contatos")) || [];
      const mensagens = JSON.parse(localStorage.getItem("mensagens")) || {};
      const conversasInfo = JSON.parse(localStorage.getItem("conversasInfo")) || {};
      return { contatos, mensagens, conversasInfo };
    }

    // Formata timestamp em "há X dias"
    function tempoDesde(timestamp) {
      if (!timestamp) return "Nunca";
      const diffMs = Date.now() - timestamp;
      const diffDias = Math.floor(diffMs / (1000 * 60 * 60 * 24));
      if (diffDias === 0) return "Hoje";
      if (diffDias === 1) return "Ontem";
      return `Há ${diffDias} dias`;
    }

    // Formata duração em segundos para mm:ss
    function formatarDuracao(segundos) {
      const m = Math.floor(segundos / 60);
      const s = segundos % 60;
      return `${m}m ${s}s`;
    }

    // Remove contato e suas mensagens
    function excluirContato(telefone) {
      if (!confirm("Deseja excluir este contato e suas mensagens?")) return;
      let { contatos, mensagens, conversasInfo } = pegarDados();

      contatos = contatos.filter(c => c.numero !== telefone);
      delete mensagens[telefone];
      delete conversasInfo[telefone];

      localStorage.setItem("contatos", JSON.stringify(contatos));
      localStorage.setItem("mensagens", JSON.stringify(mensagens));
      localStorage.setItem("conversasInfo", JSON.stringify(conversasInfo));

      montarDashboard();
      alert("Contato e mensagens excluídos com sucesso.");
    }

    // Calcula média semanal de mensagens nos últimos 4 semanas
    function calcularMediaSemanal(mensagens) {
      const agora = Date.now();
      const quatroSemanasMs = 4 * 7 * 24 * 60 * 60 * 1000;
      const limite = agora - quatroSemanasMs;

      let totalMsgsUltimas4Semanas = 0;

      for (const msgs of Object.values(mensagens)) {
        for (const m of msgs) {
          if (m.timestamp >= limite && !isDisparo(m.texto)) {
            totalMsgsUltimas4Semanas++;
          }
        }
      }

      return (totalMsgsUltimas4Semanas / 4).toFixed(2);
    }

    // Monta calendário mensal com total de mensagens por dia (mês atual)
    function montarCalendario(mensagens) {
      const calendarioEl = document.getElementById("calendario");
      calendarioEl.innerHTML = "";

      const hoje = new Date();
      const ano = hoje.getFullYear();
      const mes = hoje.getMonth(); // 0-based

      // Quantos dias tem o mês
      const diasNoMes = new Date(ano, mes + 1, 0).getDate();

      // Contagem de msgs por dia
      const contagemDia = {};
      for (let d = 1; d <= diasNoMes; d++) contagemDia[d] = 0;

      // Conta mensagens (não disparo) no mês atual
      for (const msgs of Object.values(mensagens)) {
        for (const m of msgs) {
          const dt = new Date(m.timestamp);
          if (dt.getFullYear() === ano && dt.getMonth() === mes && !isDisparo(m.texto)) {
            const dia = dt.getDate();
            contagemDia[dia]++;
          }
        }
      }

      // Cria os dias na grid
      for (let d = 1; d <= diasNoMes; d++) {
        const div = document.createElement("div");
        div.className = "calendar-day";
        div.dataset.msgs = contagemDia[d];
        div.title = `Dia ${d}: ${contagemDia[d]} mensagens`;
        div.textContent = d;
        calendarioEl.appendChild(div);
      }
    }

    // Conta mensagens válidas (filtrando disparos) e conversa válida >=10s
    function contarMensagensValidas(msgs, duracaoSeg) {
      const msgsValidas = msgs.filter(m => !isDisparo(m.texto));
      // Conversa só válida se duração >= 10 segundos
      if (duracaoSeg < 10) return 0;
      return msgsValidas.length;
    }

    // Monta dashboard com dados e filtros
    function montarDashboard() {
      const { contatos, mensagens, conversasInfo } = pegarDados();

      let conversasValidas = 0; // contatos com >=3 msgs válidas e >=10s
      let chamadas = 0; // contatos com 1 msg válida (desconsiderando disparo)
      let semConversa = 0; // contatos sem msgs

      let somaDuracaoSegs = 0;
      let totalMsgs = 0;

      const tbody = document.getElementById("listaGestor");
      tbody.innerHTML = "";

      contatos.forEach(contato => {
        const msgs = mensagens[contato.numero] || [];
        const duracaoSeg = (conversasInfo[contato.numero]?.duracaoTotalSeg) || 0;
        const msgsValidas = msgs.filter(m => !isDisparo(m.texto));
        const qtdMsgsValidas = (duracaoSeg >= 10) ? msgsValidas.length : 0;

        if (qtdMsgsValidas >= 3) conversasValidas++;
        else if (qtdMsgsValidas === 1) chamadas++;
        else semConversa++;

        somaDuracaoSegs += duracaoSeg;
        totalMsgs += msgsValidas.length;

        const ultimaMsgTimestamp = msgs.length ? msgs[msgs.length - 1].timestamp : null;

        const tr = document.createElement("tr");
        tr.className = "border border-gray-300";

        tr.innerHTML = `
          <td class="p-2 border border-gray-300">${contato.nome}</td>
          <td class="p-2 border border-gray-300">${contato.numero}</td>
          <td class="p-2 border border-gray-300">${contato.origem || "-"}</td>
          <td class="p-2 border border-gray-300 text-center">${qtdMsgsValidas}</td>
          <td class="p-2 border border-gray-300 text-center">${tempoDesde(ultimaMsgTimestamp)}</td>
          <td class="p-2 border border-gray-300 text-center">${formatarDuracao(duracaoSeg)}</td>
          <td class="p-2 border border-gray-300 text-center">
            <button
              onclick="excluirContato('${contato.numero}')"
              class="bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700 transition"
              title="Excluir contato e mensagens"
            >
              <i class="fas fa-trash"></i>
            </button>
          </td>
        `;

        tbody.appendChild(tr);
      });

      document.getElementById("totalConversas").textContent = conversasValidas;
      document.getElementById("totalChamadas").textContent = chamadas;
      document.getElementById("contatosSemConversa").textContent = semConversa;

      const mediaSemanal = calcularMediaSemanal(mensagens);
      document.getElementById("mediaSemanal").textContent = mediaSemanal;

      document.getElementById("tempoTotalConversas").textContent = formatarDuracao(somaDuracaoSegs);

      montarCalendario(mensagens);
    }

    window.addEventListener("DOMContentLoaded", () => {
      montarDashboard();
    });
  </script>
</body>
</html>
