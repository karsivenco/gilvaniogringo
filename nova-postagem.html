<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nova Postagem - Intranet do Gringo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
  />
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex justify-between items-center bg-[#09679c] text-white p-4 shadow-md">
    <div class="flex items-center gap-3">
      <img src="img/logo.png" alt="Logo Gringo" class="h-10 w-auto" />
      <h1 class="text-xl font-bold">Nova Postagem</h1>
    </div>

    <nav class="flex items-center gap-3">
      <a href="painel.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition flex items-center gap-1" title="Painel">
        <i class="fas fa-home"></i> Painel
      </a>
      <a href="nova-postagem.html" class="bg-[#053646] border border-white px-3 py-2 rounded hover:bg-[#032d39] transition flex items-center gap-1" title="Nova Postagem">
        <i class="fas fa-plus"></i> Nova Postagem
      </a>
      <a href="publicacoes.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition flex items-center gap-1" title="Últimas Publicações">
        <i class="fas fa-newspaper"></i> Últimas Publicações
      </a>
      <a href="rascunhos.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition flex items-center gap-1" title="Rascunhos">
        <i class="fas fa-file-alt"></i> Rascunhos
      </a>
      <a href="perfil.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition flex items-center gap-1" title="Perfil">
        <i class="fas fa-user"></i> Perfil
      </a>
      <button
        onclick="logout()"
        class="bg-[#053646] px-3 py-2 rounded hover:bg-[#032d39] transition flex items-center gap-1"
        title="Sair"
      >
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </nav>
  </header>

  <!-- Conteúdo -->
  <main class="flex-grow p-6 max-w-4xl mx-auto bg-white rounded shadow mt-6 mb-10">

    <form id="formPost" class="space-y-6">
      <div>
        <label for="titulo" class="block font-semibold mb-1">Título da postagem</label>
        <input
          type="text"
          id="titulo"
          name="titulo"
          class="w-full border border-gray-300 rounded px-3 py-2"
          required
          maxlength="100"
        />
      </div>

      <div>
        <label for="conteudo" class="block font-semibold mb-1">Conteúdo (HTML permitido)</label>
        <textarea
          id="conteudo"
          name="conteudo"
          rows="10"
          class="w-full border border-gray-300 rounded px-3 py-2"
          required
        ></textarea>
      </div>

      <div class="flex gap-4">
        <button
          type="submit"
          class="bg-[#09679c] text-white px-6 py-2 rounded hover:bg-[#074d6b] transition"
        >
          Salvar Rascunho
        </button>

        <button
          type="button"
          id="btnPublicar"
          class="bg-green-600 text-white px-6 py-2 rounded hover:bg-green-700 transition"
        >
          Publicar
        </button>
      </div>
    </form>

  </main>

  <script type="module">
    import { gerarHtmlPostCompleto } from './post.js';

    // Pega usuário logado do localStorage
    const usuarioLogado = localStorage.getItem('usuarioLogado');

    function logout() {
      localStorage.removeItem('usuarioLogado');
      window.location.href = 'intranet.html';
    }

    // Salvar rascunho no localStorage
    function salvarRascunho(post) {
      const rascunhos = JSON.parse(localStorage.getItem('rascunhos')) || [];

      // Se já existir (edição), atualiza, senão cria novo
      const indexExistente = rascunhos.findIndex(r => r.id === post.id);
      if (indexExistente !== -1) {
        rascunhos[indexExistente] = post;
      } else {
        rascunhos.push(post);
      }

      localStorage.setItem('rascunhos', JSON.stringify(rascunhos));
    }

    // Gera ID único simples
    function gerarId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2);
    }

    // Carrega dados para edição se houver ?id= no URL
    function carregarEdicao() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id');
      if (!id) return null;

      const rascunhos = JSON.parse(localStorage.getItem('rascunhos')) || [];
      return rascunhos.find(r => r.id === id) || null;
    }

    // Baixa arquivo HTML gerado da publicação
    function baixarArquivo(nomeArquivo, conteudo) {
      const blob = new Blob([conteudo], { type: 'text/html;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = nomeArquivo;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      URL.revokeObjectURL(link.href);
    }

    document.getElementById('formPost').addEventListener('submit', e => {
      e.preventDefault();

      const titulo = e.target.titulo.value.trim();
      const conteudo = e.target.conteudo.value.trim();

      if (!titulo || !conteudo) {
        alert('Preencha título e conteúdo.');
        return;
      }

      const post = {
        id: carregarEdicao()?.id || gerarId(),
        titulo,
        conteudo,
        autor: usuarioLogado || 'anônimo',
        data: new Date().toISOString(),
        status: 'rascunho'
      };

      salvarRascunho(post);
      alert('Rascunho salvo com sucesso!');
      // Você pode limpar o formulário ou não — aqui só atualiza data e mantém conteúdo
      e.target.conteudo.value = conteudo;
      e.target.titulo.value = titulo;
      // Atualiza URL para edição do mesmo rascunho
      history.replaceState(null, '', `nova-postagem.html?id=${post.id}`);
    });

    document.getElementById('btnPublicar').addEventListener('click', () => {
      const titulo = document.getElementById('titulo').value.trim();
      const conteudo = document.getElementById('conteudo').value.trim();

      if (!titulo || !conteudo) {
        alert('Preencha título e conteúdo para publicar.');
        return;
      }

      if (!confirm('Deseja publicar esta postagem?')) return;

      let rascunhos = JSON.parse(localStorage.getItem('rascunhos')) || [];
      let publicacoes = JSON.parse(localStorage.getItem('publicacoes')) || [];

      // Se está editando, usa o mesmo id, senão gera novo
      const params = new URLSearchParams(window.location.search);
      const id = params.get('id') || gerarId();

      // Remove da lista de rascunhos, se existir
      rascunhos = rascunhos.filter(r => r.id !== id);

      const post = {
        id,
        titulo,
        conteudo,
        autor: usuarioLogado || 'anônimo',
        data: new Date().toISOString(),
        status: 'publicado'
      };

      // Adiciona na lista de publicações
      publicacoes.push(post);

      // Salva listas atualizadas
      localStorage.setItem('rascunhos', JSON.stringify(rascunhos));
      localStorage.setItem('publicacoes', JSON.stringify(publicacoes));

      // Gera HTML completo via função importada
      const htmlCompleto = gerarHtmlPostCompleto(post);

      // Gera slug para nome do arquivo
      function gerarSlug(texto) {
        return texto.toLowerCase()
          .normalize('NFD').replace(/[\u0300-\u036f]/g, '')
          .replace(/\s+/g, '-')
          .replace(/[^\w\-]+/g, '')
          .replace(/\-\-+/g, '-')
          .replace(/^-+/, '')
          .replace(/-+$/, '');
      }

      const nomeArquivo = gerarSlug(titulo) + '.html';

      // Baixa arquivo HTML
      baixarArquivo(nomeArquivo, htmlCompleto);

      alert('Postagem publicada com sucesso!');

      // Redireciona para publicações ou limpa formulário
      window.location.href = 'publicacoes.html';
    });

    // Se estiver editando, carrega os dados no formulário
    window.onload = () => {
      if (!usuarioLogado) {
        alert('Você precisa estar logado para acessar esta página.');
        window.location.href = 'intranet.html';
        return;
      }
      const post = carregarEdicao();
      if (post) {
        document.getElementById('titulo').value = post.titulo;
        document.getElementById('conteudo').value = post.conteudo;
      }
    };

  </script>

</body>
</html>
