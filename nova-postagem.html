<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Nova Postagem - Intranet do Gringo</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link
    rel="stylesheet"
    href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
    crossorigin="anonymous"
  />
</head>
<body class="bg-gray-100 min-h-screen flex flex-col">

  <!-- Header -->
  <header class="flex justify-between items-center bg-[#09679c] text-white p-4 shadow-md">
    <div class="flex items-center gap-3">
      <img src="img/logo.png" alt="Logo Gringo" class="h-10 w-auto" />
      <h1 class="text-xl font-bold">Nova Postagem</h1>
    </div>
    <nav class="flex items-center gap-3">
      <a href="painel.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition flex items-center gap-1" title="Painel">
        <i class="fas fa-home"></i> Painel
      </a>
      <a href="nova-postagem.html" class="bg-[#053646] border border-white px-3 py-2 rounded hover:bg-[#032d39] transition flex items-center gap-1" title="Nova Postagem">
        <i class="fas fa-plus"></i> Nova Postagem
      </a>
      <a href="rascunhos.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition flex items-center gap-1" title="Rascunhos">
        <i class="fas fa-file-alt"></i> Rascunhos
      </a>
      <a href="ultimas-noticias2.html" class="bg-[#09679c] border border-white px-3 py-2 rounded hover:bg-[#074d6b] transition flex items-center gap-1" title="Últimas Publicações">
        <i class="fas fa-newspaper"></i> Últimas Publicações
      </a>
      <button
        onclick="logout()"
        class="bg-[#053646] px-3 py-2 rounded hover:bg-[#032d39] transition flex items-center gap-1"
        title="Sair"
      >
        <i class="fas fa-sign-out-alt"></i> Sair
      </button>
    </nav>
  </header>

  <!-- Main -->
  <main class="flex-grow p-6 max-w-5xl mx-auto bg-white rounded shadow mt-6 mb-10">
    <form id="formPostagem" class="flex flex-col gap-4">
      <label for="titulo" class="font-semibold text-gray-700">Título:</label>
      <input type="text" id="titulo" name="titulo" required class="border p-2 rounded" />

      <label for="conteudo" class="font-semibold text-gray-700">Conteúdo:</label>
      <textarea id="conteudo" name="conteudo" rows="10" required class="border p-2 rounded"></textarea>

      <div class="flex gap-4">
        <button type="button" id="btnSalvarRascunho" class="bg-yellow-400 hover:bg-yellow-500 text-black px-6 py-2 rounded font-semibold">
          Salvar Rascunho
        </button>
        <button type="submit" id="btnPublicar" class="bg-green-600 hover:bg-green-700 text-white px-6 py-2 rounded font-semibold">
          Enviar Publicação
        </button>
      </div>
    </form>

    <div id="notificacao" class="fixed bottom-5 right-5 bg-green-600 text-white px-6 py-3 rounded shadow-lg hidden"></div>
  </main>

  <script>
    // Logout
    function logout() {
      localStorage.removeItem("usuarioLogado");
      window.location.href = "intranet.html";
    }

    // Pega usuário logado
    const usuarioLogado = localStorage.getItem("usuarioLogado");
    if (!usuarioLogado) {
      alert("Usuário não logado. Faça login.");
      window.location.href = "intranet.html";
    }

    // Pega elementos
    const form = document.getElementById("formPostagem");
    const inputTitulo = document.getElementById("titulo");
    const textareaConteudo = document.getElementById("conteudo");
    const btnSalvarRascunho = document.getElementById("btnSalvarRascunho");
    const notificacao = document.getElementById("notificacao");

    // LocalStorage keys
    const KEY_RASCUNHOS = "rascunhos";
    const KEY_PUBLICACOES = "publicacoes";

    // Função para gerar ID único simples
    function gerarId() {
      return 'id-' + Date.now() + '-' + Math.floor(Math.random() * 1000);
    }

    // Função para mostrar notificação
    function mostrarNotificacao(mensagem, tipo = "sucesso") {
      notificacao.textContent = mensagem;
      notificacao.className = "fixed bottom-5 right-5 px-6 py-3 rounded shadow-lg z-50";
      if (tipo === "sucesso") {
        notificacao.classList.add("bg-green-600", "text-white");
      } else if (tipo === "erro") {
        notificacao.classList.add("bg-red-600", "text-white");
      } else {
        notificacao.classList.add("bg-gray-700", "text-white");
      }
      notificacao.style.display = "block";
      setTimeout(() => {
        notificacao.style.display = "none";
      }, 4000);
    }

    // Função para salvar rascunho (não publica)
    function salvarRascunho() {
      const titulo = inputTitulo.value.trim();
      const conteudo = textareaConteudo.value.trim();

      if (!titulo && !conteudo) {
        mostrarNotificacao("Nada para salvar.", "erro");
        return;
      }

      let rascunhos = JSON.parse(localStorage.getItem(KEY_RASCUNHOS)) || [];

      // Se estiver editando (id na URL), atualiza rascunho
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");
      const agora = new Date().toISOString();

      if (id) {
        // Atualizar rascunho existente
        const idx = rascunhos.findIndex(r => r.id === id);
        if (idx > -1) {
          rascunhos[idx].titulo = titulo;
          rascunhos[idx].conteudo = conteudo;
          rascunhos[idx].data = agora;
        } else {
          // Caso não encontre, cria novo
          rascunhos.push({ id: id, autor: usuarioLogado, titulo, conteudo, data: agora });
        }
      } else {
        // Criar novo
        rascunhos.push({ id: gerarId(), autor: usuarioLogado, titulo, conteudo, data: agora });
      }

      localStorage.setItem(KEY_RASCUNHOS, JSON.stringify(rascunhos));
      mostrarNotificacao("Rascunho salvo com sucesso.");
    }

    // Função para publicar: salvar em publicações E atualizar/retirar do rascunho
    function publicar() {
      const titulo = inputTitulo.value.trim();
      const conteudo = textareaConteudo.value.trim();

      if (!titulo || !conteudo) {
        mostrarNotificacao("Título e conteúdo são obrigatórios para publicar.", "erro");
        return;
      }

      let publicacoes = JSON.parse(localStorage.getItem(KEY_PUBLICACOES)) || [];
      let rascunhos = JSON.parse(localStorage.getItem(KEY_RASCUNHOS)) || [];
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");
      const agora = new Date().toISOString();

      if (id) {
        // Atualiza publicação existente
        const idxPub = publicacoes.findIndex(p => p.id === id);
        if (idxPub > -1) {
          publicacoes[idxPub].titulo = titulo;
          publicacoes[idxPub].conteudo = conteudo;
          publicacoes[idxPub].dataHora = agora;
          publicacoes[idxPub].autor = usuarioLogado;
        } else {
          // Caso não encontre publicação, adiciona nova
          publicacoes.push({ id: id, autor: usuarioLogado, titulo, conteudo, dataHora: agora });
        }

        // Remove rascunho correspondente, se existir
        rascunhos = rascunhos.filter(r => r.id !== id);

      } else {
        // Novo
        const novoId = gerarId();
        publicacoes.push({ id: novoId, autor: usuarioLogado, titulo, conteudo, dataHora: agora });
      }

      // Atualiza localStorage
      localStorage.setItem(KEY_PUBLICACOES, JSON.stringify(publicacoes));
      localStorage.setItem(KEY_RASCUNHOS, JSON.stringify(rascunhos));

      mostrarNotificacao("Publicação enviada com sucesso.");

      // Limpa formulário e remove parâmetro id da URL para evitar reenvio confuso
      inputTitulo.value = "";
      textareaConteudo.value = "";
      history.replaceState(null, "", window.location.pathname);
    }

    // Carrega dados para edição caso tenha ?id=xxx na URL (busca em rascunhos ou publicações)
    function carregarEdicao() {
      const urlParams = new URLSearchParams(window.location.search);
      const id = urlParams.get("id");
      if (!id) return;

      const rascunhos = JSON.parse(localStorage.getItem(KEY_RASCUNHOS)) || [];
      const publicacoes = JSON.parse(localStorage.getItem(KEY_PUBLICACOES)) || [];

      let post = rascunhos.find(p => p.id === id) || publicacoes.find(p => p.id === id);
      if (post) {
        inputTitulo.value = post.titulo;
        textareaConteudo.value = post.conteudo;
      }
    }

    // Eventos
    btnSalvarRascunho.addEventListener("click", e => {
      e.preventDefault();
      salvarRascunho();
    });

    form.addEventListener("submit", e => {
      e.preventDefault();
      publicar();
    });

    // Inicialização
    window.onload = () => {
      carregarEdicao();
    };
  </script>
</body>
</html>
